<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=format-detection content="telephone=no"><title>Kcc Oci and Cosign | Chris' Blog</title><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/manifest.json><link rel=mask-icon href=/safari-pinned-tab.svg color=#ff3db4><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://cartyc.github.io/css/main.min.117c4a1a499fdd8cd5e8d4c46c99205824a1acf2e5929a1341310b4432e4794f.css></head><body><nav><header><div class=site-title><a href=/>Chris' Blog</a></div></header><div class=nav-menu><a class="color-link nav-link" href=https://cartyc.github.io/index.xml target=_blank rel=noopener type=application/rss+xml>RSS</a></div><footer class=footer><div class=social-icons><a class=social-icon href=https://twitter.com/macintoshprime target=_blank rel=noopener title=Twitter><svg width="28" height="28" viewBox="0 0 28 28" fill="#ababab" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink"><path d="M8.991284 24.971612c10.189152.0 15.761088-8.441388 15.761088-15.761088C24.752372 8.970656 24.747512 8.731868 24.736496 8.494376 25.818008 7.712564 26.758256 6.737 27.5 5.62622c-.992628.440856-2.060748.738072-3.181248.871992 1.14372-.685584 2.02176-1.770768 2.435832-3.064176-1.070496.6345-2.25558 1.095984-3.517344 1.344492-1.010772-1.076652-2.450412-1.75014-4.043412-1.75014-3.059424.0-5.540292 2.480868-5.540292 5.539104.0.434808.0487079999999995.857412.14364 1.26306C9.19346 9.599108 5.11106 7.39472 2.3792 4.04294c-.476172.818424-.750168 1.769688-.750168 2.784132.0 1.921968.97794 3.61854 2.464992 4.61106C3.185528 11.41016 2.331788 11.160464 1.585184 10.745096 1.583888 10.768208 1.583888 10.791428 1.583888 10.815728c0 2.683152 1.909764 4.922856 4.4442 5.43078C5.562932 16.373084 5.07326 16.44134 4.56782 16.44134 4.210988 16.44134 3.863876 16.406024 3.526484 16.34144c.70524 2.200824 2.750112 3.802356 5.174928 3.8475-1.896264 1.485756-4.284576 2.37114-6.879924 2.37114C1.374476 22.56008.93362 22.534592.5 22.4834c2.451708 1.571076 5.362524 2.488212 8.491284 2.488212"/></svg></a><a class=social-icon href=https://www.linkedin.com/in/chriscarty/ target=_blank rel=noopener title=LinkedIn><svg width="28" height="28" viewBox="0 0 28 28" fill="#ababab" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink"><path d="M2 3.654102c0-.95502059.79442509-1.73012354 1.77383592-1.73012354H24.2261641C25.2058917 1.92397846 26 2.69908141 26 3.654102V24.3462148C26 25.3015521 25.2058917 26.0760215 24.2261641 26.0760215H3.77383592C2.79442509 26.0760215 2 25.3015521 2 24.3465315V3.65378524 3.654102zM9.27526132 22.1415901V11.2356668H5.65030092V22.1415901H9.27557808 9.27526132zM7.46341463 9.74691162c1.2638581.0 2.05068103-.83750395 2.05068103-1.88406715C9.49033893 6.79252455 8.72727273 5.97846056 7.48748812 5.97846056c-1.24073487.0-2.05099778.81406399-2.05099778 1.88438391.0 1.0465632.78650618 1.88406715 2.00316756 1.88406715h.02343998H7.46341463zM11.2815965 22.1415901h3.6246436v-6.089642C14.9062401 15.7263225 14.9299968 15.4000634 15.0256573 15.1675641c.261957499999999-.6515679.8584099-1.3259423 1.8599936-1.3259423 1.3113716.0 1.836237 1 1.836237 2.4662654v5.8337029h3.6246436V15.8885017c0-3.349699-1.7880899-4.9084574-4.172949-4.9084574-1.9553373.0-2.814064 1.0928097-3.2910991 1.8371872H14.9065569v-1.581248H11.2819132C11.3291099 12.2591067 11.2815965 22.1419069 11.2815965 22.1419069V22.1415901z"/></svg></a><a class=social-icon href=https://github.com/cartyc/ target=_blank rel=noopener title=GitHub><svg width="28" height="28" viewBox="0 0 28 28" fill="#ababab" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink"><path d="M13.9988029 1.32087331C6.82105037 1.32087331 1 7.14112562 1 14.3212723c0 5.7436386 3.72454649 10.6157955 8.89038951 12.3348169C10.5408085 26.7757983 10.7778323 26.374374 10.7778323 26.0296121 10.7778323 25.7215609 10.7666595 24.9035493 10.760275 23.8189856 7.14426471 24.6042767 6.38131925 22.0760223 6.38131925 22.0760223c-.59136253-1.5019491-1.44369072-1.9017772-1.44369072-1.9017772C3.75729765 19.3682044 5.02701126 19.3841656 5.02701126 19.3841656 6.33183953 19.4759425 7.01817121 20.7241085 7.01817121 20.7241085c1.15958133 1.9863716 3.04300319 1.4125664 3.78360289 1.0797753.1181129-.8395592.4540962-1.4125663.8251942-1.7373768C8.74038491 19.7385043 5.70536235 18.6228163 5.70536235 13.6413251c0-1.4189508.50676816-2.5801283 1.33834679-3.4883207C6.90963504 9.82420367 6.46351945 8.50181809 7.17139875 6.71256734c0 0 1.09094816-.34955032 3.57451115 1.33276037C11.78259 7.75642995 12.8950858 7.61277914 14.000399 7.60719272 15.1049142 7.61277914 16.2166119 7.75642995 17.2548881 8.04532771c2.4819669-1.68231069 3.571319-1.33276037 3.571319-1.33276037C21.5356825 8.50181809 21.0895669 9.82420367 20.9562909 10.1530044 21.7894656 11.0611968 22.2922435 12.2223743 22.2922435 13.6413251c0 4.9942601-3.039811 6.0931889-5.935173 6.4148071.4660671.401424200000001.8818564 1.194696.8818564 2.4077473C17.2389269 24.2012564 17.2229657 25.603448 17.2229657 26.0296121 17.2229657 26.3775663 17.4575954 26.7821827 18.116793 26.6552912 23.2786458 24.9322794 27 20.0633148 27 14.3212723 27 7.14112562 21.1789496 1.32087331 13.9988029 1.32087331"/></svg></a></div><p><a href=https://github.com/kimcc/hugo-theme-noteworthy target=_blank rel=noopener>Noteworthy theme</a></p><p><a href=https://gohugo.io target=_blank rel=noopener>Built with Hugo</a></p><script src=https://cartyc.github.io/js/main.min.a7205ef73b078c8daed6fe1b0826e8ba229ffabbb69d299d9446cf41f2c7d8aa.js integrity="sha256-pyBe9zsHjI2u1v4bCCbouiKf+ru2nSmdlEbPQfLH2Ko=" crossorigin=anonymous></script></footer></nav><div id=content class=content-container><h1 class=post-title>Kcc Oci and Cosign</h1><time>November 16, 2022</time><div><p><h1 id=signing-oci-kcc-artifacts-using-cosign>Signing OCI KCC Artifacts Using <code>cosign</code></h1><p>I&rsquo;ve been meaning to try out <a href=https://github.com/sigstore/cosign>cosign</a> to sign OCI artifacts for a while now and recently had a chance to give it a whirl and well it&rsquo;s pretty awesome.</p><p>My usecase I wanted to apply this too was to use the new OCI support in <a href=https://cloud.google.com/anthos-config-management/docs/how-to/sync-oci-artifacts-from-artifact-registry>Config Sync</a> to deploy <a href=https://cloud.google.com/config-connector/docs/overview>Kubernetes Config Connector</a> resources and I thought it would be really interesting to start signing those OCI artifacts for added security and well applying that to infrastructure was really intriguing and exciting!</p><p>While this is a very GCP centric view on things I think it could be equally applied to <a href=https://github.com/crossplane/crossplane>crossplane</a> resources as well!</p><p>Before we start I am assuming you have a GCP project and are the owner of said project.</p><p>To kick things off we&rsquo;ll set some environment variables that we&rsquo;ll use through the examples. We&rsquo;ll be creating some keys in KMS for use during signing and and Artifact Registry to store the OCI artifact and the <code>cosign</code> signature.</p><h2 id=set-env-variables>Set env variables</h2><pre tabindex=0><code>PROJECT_ID=&lt;targetprojectid&gt;
KEYRING=&lt;keyring&gt;
KEYNAME=&lt;keyname&gt;
REGION=&lt;region&gt;
REGISTRY_NAME=&lt;registry-name&gt;
CONTAINER_NAME=&lt;container-name&gt;
</code></pre><p>Next up let&rsquo;s enable the required services.</p><h2 id=enable-required-services>Enable Required Services</h2><pre tabindex=0><code>gcloud services enable artifactregistry.googleapis.com
gcloud services enable cloudkms.googleapis.com
</code></pre><h2 id=create-keyring>create keyring</h2><p>For this part we&rsquo;ll need to create a keyring and then a key that <code>cosign</code> will use to sign the artifact.</p><pre tabindex=0><code>gcloud kms keyrings create $KEYRING \
    --location $REGION
</code></pre><h2 id=create-key>Create Key</h2><pre tabindex=0><code>gcloud kms keys create $KEYNAME \
    --keyring $KEYRING \
    --location northamerica-northeast1 \
    --purpose &#34;asymmetric-signing&#34; \
    --default-algorithm=ec-sign-p256-sha256
</code></pre><h2 id=create-artifact-registry>Create Artifact Registry</h2><p>And the last piece of infrastructure we&rsquo;ll need, the registry.</p><pre tabindex=0><code>gcloud artifacts repositories create ${REGISTRY_NAME} \
    --repository-format=docker \
    --location $REGION
</code></pre><p>and login to the registry so we can push to it later</p><pre tabindex=0><code>gcloud auth configure-docker ${REGION}-docker.pkg.dev
</code></pre><h2 id=install-oras-and-cosign>Install Oras and Cosign</h2><p>Finally we can do the fun stuff. This little snippet will download and install <code>oras</code> which we&rsquo;ll use to push the file to Artifact Registry and <code>cosign</code>.</p><pre tabindex=0><code>echo &#34;Install Cosign&#34;
wget https://github.com/sigstore/cosign/releases/download/v1.13.1/cosign-linux-amd64
chmod +x cosign-linux-amd64
mv cosign-linux-amd64 cosign
echo &#34;Install Oras&#34;
curl -LO https://github.com/oras-project/oras/releases/download/v0.16.0/oras_0.16.0_linux_amd64.tar.gz
mkdir -p oras-install/
tar -zxf oras_0.16.0_*.tar.gz -C oras-install/
mv oras-install/oras /usr/local/bin/
rm -rf oras_0.16.0_*.tar.gz oras-install/
</code></pre><h2 id=create-some-yaml-and-tar-it>Create some YAML and tar it</h2><p>For my nefarious use case I want to deploy a GKE Autopilot cluster thats using Anthos Service Mesh, we won&rsquo;t actually be deploying this but if you want to you can check out <a href=https://cloud.google.com/anthos-config-management/docs/concepts/config-controller-overview>config controller</a> (one of my favorite services).</p><p>First let&rsquo;s make a new folder so we can keep things neat and tidy.</p><pre tabindex=0><code>mkdir cosign-oci/
</code></pre><p>And then we&rsquo;ll <code>cat</code> the configs into a file called <code>gke.yaml</code>.</p><pre tabindex=0><code>cat &lt;&lt;EOF &gt; ./cosign-oci/gke.yaml
apiVersion: container.cnrm.cloud.google.com/v1beta1
kind: ContainerCluster
metadata:
  name: oci-cosigned
spec:
  description: An OCI&#39;d autopilot cluster.
  enableAutopilot: true
  location: $REGION
  releaseChannel:
    channel: REGULAR
---
apiVersion: gkehub.cnrm.cloud.google.com/v1beta1
kind: GKEHubFeatureMembership
metadata:
  name: oci-cosigned-mesh-membership
spec:
  projectRef:
    external: $PROJECT_ID
  location: global
  membershipRef:
    name: oci-cosigned-hub
  featureRef:
    name: servicemesh
  mesh:
    management: MANAGEMENT_AUTOMATIC
---
apiVersion: gkehub.cnrm.cloud.google.com/v1beta1
kind: GKEHubMembership
metadata:
  name: oci-cosigned-hub
spec:
  location: global
  authority:
    issuer: &#39;https://container.googleapis.com/v1/projects/${PROJECT_ID}/locations/${REGION}/clusters/oci-cosigned&#39;
  description: oci-cosigned Cluster
  endpoint:
    gkeCluster:
      resourceRef:
        name: oci-cosigned
EOF
</code></pre><p>Now that we have that done all that&rsquo;s left is to <code>tar</code> the file and tell <code>oras</code> to push it to artifact registry.</p><pre tabindex=0><code>tar -cf ./example.tar ./cosign-oci/gke.yaml
</code></pre><p>Now we should be good to push the file to the registry!</p><p>I&rsquo;ve wrapped the command like this so we can quickly grab the <code>sha</code> digest that <code>oras</code> produces so we can drop that into the <code>cosign</code> command easier.</p><pre tabindex=0><code>SHA=$(oras push ${REGION}-docker.pkg.dev/${PROJECT_ID}/${REGISTRY_NAME}/${CONTAINER_NAME} example.tar | grep Digest: | cut -f2 -d&#34; &#34;)
</code></pre><h2 id=set-up-cosign>Set up Cosign</h2><p>For <code>cosign</code> to work right it will need you to set the <code>application-default</code> credentials.</p><pre tabindex=0><code>gcloud auth application-default login
</code></pre><p>Once logged in you can go ahead and create the keypair we&rsquo;ll use for signing.</p><pre tabindex=0><code>cosign generate-key-pair --kms gcpkms://projects/${PROJECT_ID}/locations/${REGION}/keyRings/${KEYRING}/cryptoKeys/${KEYNAME}
</code></pre><p>and finally sign the artifact.</p><pre tabindex=0><code>cosign sign --key gcpkms://projects/${PROJECT_ID}/locations/${REGION}/keyRings/${KEYRING}/cryptoKeys/${KEYNAME} ${REGION}-docker.pkg.dev/${PROJECT_ID}/${REGISTRY_NAME}/${CONTAINER_NAME}@${SHA}
</code></pre><h2 id=verify-what-was-created>Verify what was created</h2><p>Now that we&rsquo;ve signed the artifact, how do we verify it? Luckily it&rsquo;s pretty simple in that we just need to run the following command from a place that has access to view the key we created earlier and the artifact registry.</p><pre tabindex=0><code>cosign verify --key gcpkms://projects/${PROJECT_ID}/locations/${REGION}/keyRings/${KEYRING}/cryptoKeys/${KEYNAME} ${REGION}-docker.pkg.dev/${PROJECT_ID}/${REGISTRY_NAME}/${CONTAINER_NAME}@${SHA}
</code></pre><p>Voilia you&rsquo;ve now signed your KCC infra with cosign!</p><h2 id=set-up-cosign-and-cloud-build>Set Up Cosign and Cloud Build</h2><p>For additional fun and profit I set up a test cloud build pipeline that runs through this.</p><p>Cloud Build Permissions
Key verifier/signer
key viewer</p><pre tabindex=0><code>steps:
- name: ubuntu
  script: |
    tar -cf /workspace/example.tar environments
- name: ubuntu
  env:
    - &#39;PROJECT_ID=$PROJECT_ID&#39;
    - &#39;COMMIT_SHA=$COMMIT_SHA&#39;
  script: |
    apt update
    apt install wget curl -y
    echo &#34;Install Cosign&#34;
    wget https://github.com/sigstore/cosign/releases/download/v1.13.1/cosign-linux-amd64
    chmod +x cosign-linux-amd64
    mv cosign-linux-amd64 cosign
    echo &#34;Install Oras&#34;
    curl -LO https://github.com/oras-project/oras/releases/download/v0.16.0/oras_0.16.0_linux_amd64.tar.gz
    mkdir -p oras-install/
    tar -zxf oras_0.16.0_*.tar.gz -C oras-install/
    mv oras-install/oras /usr/local/bin/
    rm -rf oras_0.16.0_*.tar.gz oras-install/
    SHA=$(oras push ${REGION}-docker.pkg.dev/${PROJECT_ID}/${REGISTRY_NAME/${CONTAINER_NAME} example.tar | grep Digest: | cut -f2 -d&#34; &#34;)
    echo &#34;SHA&#34;
    echo $SHA
    ./cosign generate-key-pair --kms gcpkms://projects/${PROJECT_ID}/locations/${REGION}/keyRings/${KEYRING}/cryptoKeys/${KEYNAME}
    ./cosign sign --key gcpkms://projects/${PROJECT_ID}/locations/${REGION}/keyRings/${KEYRING}/cryptoKeys/${KEYNAME} ${REGION}-docker.pkg.dev/${PROJECT_ID}/${REGISTRY_NAME/${CONTAINER_NAME@${SHA}
</code></pre></p></div><div class=page-footer></div></div><footer class=footer-mobile><div class=social-icons><a class=social-icon href=https://twitter.com/macintoshprime target=_blank rel=noopener title=Twitter><svg width="28" height="28" viewBox="0 0 28 28" fill="#ababab" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink"><path d="M8.991284 24.971612c10.189152.0 15.761088-8.441388 15.761088-15.761088C24.752372 8.970656 24.747512 8.731868 24.736496 8.494376 25.818008 7.712564 26.758256 6.737 27.5 5.62622c-.992628.440856-2.060748.738072-3.181248.871992 1.14372-.685584 2.02176-1.770768 2.435832-3.064176-1.070496.6345-2.25558 1.095984-3.517344 1.344492-1.010772-1.076652-2.450412-1.75014-4.043412-1.75014-3.059424.0-5.540292 2.480868-5.540292 5.539104.0.434808.0487079999999995.857412.14364 1.26306C9.19346 9.599108 5.11106 7.39472 2.3792 4.04294c-.476172.818424-.750168 1.769688-.750168 2.784132.0 1.921968.97794 3.61854 2.464992 4.61106C3.185528 11.41016 2.331788 11.160464 1.585184 10.745096 1.583888 10.768208 1.583888 10.791428 1.583888 10.815728c0 2.683152 1.909764 4.922856 4.4442 5.43078C5.562932 16.373084 5.07326 16.44134 4.56782 16.44134 4.210988 16.44134 3.863876 16.406024 3.526484 16.34144c.70524 2.200824 2.750112 3.802356 5.174928 3.8475-1.896264 1.485756-4.284576 2.37114-6.879924 2.37114C1.374476 22.56008.93362 22.534592.5 22.4834c2.451708 1.571076 5.362524 2.488212 8.491284 2.488212"/></svg></a><a class=social-icon href=https://www.linkedin.com/in/chriscarty/ target=_blank rel=noopener title=LinkedIn><svg width="28" height="28" viewBox="0 0 28 28" fill="#ababab" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink"><path d="M2 3.654102c0-.95502059.79442509-1.73012354 1.77383592-1.73012354H24.2261641C25.2058917 1.92397846 26 2.69908141 26 3.654102V24.3462148C26 25.3015521 25.2058917 26.0760215 24.2261641 26.0760215H3.77383592C2.79442509 26.0760215 2 25.3015521 2 24.3465315V3.65378524 3.654102zM9.27526132 22.1415901V11.2356668H5.65030092V22.1415901H9.27557808 9.27526132zM7.46341463 9.74691162c1.2638581.0 2.05068103-.83750395 2.05068103-1.88406715C9.49033893 6.79252455 8.72727273 5.97846056 7.48748812 5.97846056c-1.24073487.0-2.05099778.81406399-2.05099778 1.88438391.0 1.0465632.78650618 1.88406715 2.00316756 1.88406715h.02343998H7.46341463zM11.2815965 22.1415901h3.6246436v-6.089642C14.9062401 15.7263225 14.9299968 15.4000634 15.0256573 15.1675641c.261957499999999-.6515679.8584099-1.3259423 1.8599936-1.3259423 1.3113716.0 1.836237 1 1.836237 2.4662654v5.8337029h3.6246436V15.8885017c0-3.349699-1.7880899-4.9084574-4.172949-4.9084574-1.9553373.0-2.814064 1.0928097-3.2910991 1.8371872H14.9065569v-1.581248H11.2819132C11.3291099 12.2591067 11.2815965 22.1419069 11.2815965 22.1419069V22.1415901z"/></svg></a><a class=social-icon href=https://github.com/cartyc/ target=_blank rel=noopener title=GitHub><svg width="28" height="28" viewBox="0 0 28 28" fill="#ababab" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink"><path d="M13.9988029 1.32087331C6.82105037 1.32087331 1 7.14112562 1 14.3212723c0 5.7436386 3.72454649 10.6157955 8.89038951 12.3348169C10.5408085 26.7757983 10.7778323 26.374374 10.7778323 26.0296121 10.7778323 25.7215609 10.7666595 24.9035493 10.760275 23.8189856 7.14426471 24.6042767 6.38131925 22.0760223 6.38131925 22.0760223c-.59136253-1.5019491-1.44369072-1.9017772-1.44369072-1.9017772C3.75729765 19.3682044 5.02701126 19.3841656 5.02701126 19.3841656 6.33183953 19.4759425 7.01817121 20.7241085 7.01817121 20.7241085c1.15958133 1.9863716 3.04300319 1.4125664 3.78360289 1.0797753.1181129-.8395592.4540962-1.4125663.8251942-1.7373768C8.74038491 19.7385043 5.70536235 18.6228163 5.70536235 13.6413251c0-1.4189508.50676816-2.5801283 1.33834679-3.4883207C6.90963504 9.82420367 6.46351945 8.50181809 7.17139875 6.71256734c0 0 1.09094816-.34955032 3.57451115 1.33276037C11.78259 7.75642995 12.8950858 7.61277914 14.000399 7.60719272 15.1049142 7.61277914 16.2166119 7.75642995 17.2548881 8.04532771c2.4819669-1.68231069 3.571319-1.33276037 3.571319-1.33276037C21.5356825 8.50181809 21.0895669 9.82420367 20.9562909 10.1530044 21.7894656 11.0611968 22.2922435 12.2223743 22.2922435 13.6413251c0 4.9942601-3.039811 6.0931889-5.935173 6.4148071.4660671.401424200000001.8818564 1.194696.8818564 2.4077473C17.2389269 24.2012564 17.2229657 25.603448 17.2229657 26.0296121 17.2229657 26.3775663 17.4575954 26.7821827 18.116793 26.6552912 23.2786458 24.9322794 27 20.0633148 27 14.3212723 27 7.14112562 21.1789496 1.32087331 13.9988029 1.32087331"/></svg></a></div><div class=footer-mobile-links><p><a href=https://github.com/kimcc/hugo-theme-noteworthy target=_blank rel=noopener>Noteworthy theme</a></p><span class=divider-bar>|</span><p><a href=https://gohugo.io target=_blank rel=noopener>Built with Hugo</a></p></div><script src=https://cartyc.github.io/js/main.min.a7205ef73b078c8daed6fe1b0826e8ba229ffabbb69d299d9446cf41f2c7d8aa.js integrity="sha256-pyBe9zsHjI2u1v4bCCbouiKf+ru2nSmdlEbPQfLH2Ko=" crossorigin=anonymous></script></footer></body></html>